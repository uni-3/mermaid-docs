name: Generate Mermaid Diagrams

on:
  workflow_dispatch:
  pull_request:
    paths:
      - '**.mmd'
      - '.github/workflows/gen-svg.yml'

jobs:
  generate-diagrams:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    env:
      ICON_PACKAGES: '["@iconify-json/logos", "@iconify-json/mdi"]'
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
    
    - name: Get changed files
      id: changed-files
      uses: technote-space/get-diff-action@v6
      with:
        PATTERNS: |
          **/*.mmd

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
    
    - name: Install dependencies
      run: npm ci
      if: env.GIT_DIFF_FILTERED
    
    - name: Generate Diagrams
      if: env.GIT_DIFF_FILTERED
      run: |
        ICONS_OPTION=$(echo '${{ env.ICON_PACKAGES }}' | jq -r '. | map("\"" + . + "\"") | join(" ")')
        CHANGED_FILES=${{ env.GIT_DIFF_FILTERED }}

        if [ -n "CHANGED_FILES" ]; then
          echo "Generating diagrams for changed files: $CHANGED_FILES"
          echo "with icons for archtecture diagrams: $ICONS_OPTION"
          for file in $CHANGED_FILES; do
            output_file=$(echo "$file" | sed 's/\.mmd$/.svg/' | sed 's/^docs\//docs\/auto_generated\//')

            echo "Processing $file"
            npx mmdc -i "$file" -o "$output_file" --iconPacks $ICONS_OPTION --puppeteerConfigFile puppeteer-config.json
          done
        else
          echo "No Mermaid files changed"
          exit 0
        fi

    - name: Generate Diagrams with md file
      run: npx mmdc -i ./docs/*.md -o ./docs/*.svg --iconPacks '@iconify-json/logos' '@iconify-json/mdi'
    
    - name: Auto Commit
      uses: stefanzweifel/git-auto-commit-action@v5
      with:
        commit_message: Generate Mermaid diagrams for changed files
        file_pattern: '**/*.svg'
